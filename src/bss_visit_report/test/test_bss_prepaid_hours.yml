-
  In order to test the Prepaid Hours part of Vist Report module,
-
  I create a contract with Prepaid hours management activated
-
  !record {model: account.analytic.account, id: contract_0}:
    user_id: base.user_demo
    name: Test contract
    type: contract
    use_tasks: True
    use_prepaid_hours: True
    use_timesheets: True
    invoice_on_timesheets: True
    to_invoice: hr_timesheet_invoice.timesheet_invoice_factor1
    partner_id: base.partner_demo

-
  I check the state of the contract
-
  !assert {model: account.analytic.account, id: contract_0}:
    - state == "open"
    - partner_id.id == ref('base.partner_demo')
    
-
  I check if Prepaid hours object is created
-
  !assert {model: account.analytic.account, id: contract_0}:
    - prepaid_hours_id != False
    
-
  I check correct initialization of prepaid hours object
-
  !python {model: bss_visit_report.prepaid_hours}: |
    pph_id = self.search(cr, uid, [('contract_id','=',ref('contract_0'))])
    pph = self.browse(cr, uid, pph_id)[0]
    contract = self.pool.get('account.analytic.account').browse(cr, uid, ref('contract_0'))
    
    assert pph.pph_name == contract.name, "Bad prepaid hours name (bad relation ?)"
    assert pph.total_validated_hours == 0, "Bad init value for validated hours"
    assert pph.total_added_hours == 0, "Bad init value for added hours"
    assert pph.av_amount == 0, "Bad init value for available amount"
    
-
  I add 10 hours to current prepaid hours
-
  !python {model: bss_visit_report.prepaid_hours.add_hours}: |
    import time
    pph_id = self.pool.get('bss_visit_report.prepaid_hours').search(cr, uid, [('contract_id','=',ref('contract_0'))])[0]
    id = self.create(cr, uid, {'amount': 600, 'processed_date': time.strftime('%Y-%m-%d'), 'prepaid_hours_id': pph_id})
    self.execute(cr, uid, [id])
    
-
  I check if hours were added properly
-
  !python {model: bss_visit_report.prepaid_hours}: |
    pph_id = self.search(cr, uid, [('contract_id','=',ref('contract_0'))])
    pph = self.browse(cr, uid, pph_id)[0]
    
    assert pph.total_added_hours == 600, "Bad value for added hours"
    assert pph.total_validated_hours == 0, "Bad value for validated hours"
    assert pph.av_amount == 600, "Bad value for available amount"
    
-
  In order to check correct validated and deductable hours 
-
  I create a task
-
  !record {model: project.task, id: task_0}:
    name: Test task
    project_id: !ref {model: project.project, search: "[('analytic_account_id','=',ref('contract_0'))]"}
    user_id: base.user_demo
    description: test description
    date_start: !eval time.strftime('%Y-%m-%d')
    
-
  I do a 1 hour work on the task
-
  !record {model: project.task.work, id: task_work_0}:
    name: Work on it
    hours: 1.0
    user_id: base.user_demo
    task_id: task_0
    date: !eval time.strftime('%Y-%m-%d')

-
  I close the task
-
  !python {model: project.task}: |
    self.do_close(cr, uid, ref('task_0'))
    
-
  I create a travel zone for a visit
-
  !record {model: bss_visit_report.travel_zone, id: travel_zone_0}:
    name: Travel zone 1
    amount: 30
    
-
  I create a visit report
-
  !record {model: bss_visit_report.visit, id: visit_report_0}:
    project_id: !ref {model: project.project, search: "[('analytic_account_id','=',ref('contract_0'))]"}
    user_id: base.user_demo
    date: !eval time.strftime('%Y-%m-%d')
    hour_from: 2.5
    hour_to: 3.5
    time: 1.0
    travel_time: 0.5
    travel_zone: travel_zone_0
    signer: Toto
    
-
  I validate the visit report
-
  !python {model: bss_visit_report.visit}: |
    self.action_validate(cr, uid, [ref('visit_report_0')])
    
-
  I check the state of the visit report
-
  !assert {model: bss_visit_report.visit, id: visit_report_0}:
    - state == "pending"
    
-
  I terminate the visit report
-
  !python {model: bss_visit_report.visit}: |
    self.action_terminate(cr, uid, [ref('visit_report_0')])
    
-
  I check the state of the visit report
-
  !assert {model: bss_visit_report.visit, id: visit_report_0}:
    - state == "terminated"
    
-
  I create a timesheet sheet
-
  !record {model: hr_timesheet_sheet.sheet, id: sheet_0}:
    employee_id: hr.employee_qdp
    state: new
    date_from: !eval time.strftime('%Y-%m-%d', time.strptime(time.strftime('%Y %W 1'), '%Y %W %w'))
    date_to: !eval time.strftime('%Y-%m-%d', time.strptime(time.strftime('%Y %W 0'), '%Y %W %w'))
    
-
  I check if timesheet contains correct projects
-
  !assert {model: hr_timesheet_sheet.sheet, id: sheet_0}:
    - len(account_ids) > 0, "Timesheet not in relation with project / analytic account"
    
-
  I check if timesheet contains lines
-
  !assert {model: hr_timesheet_sheet.sheet, id: sheet_0}:
    - len(timesheet_ids) > 0, "Timesheet is empty"

-
  I submit the sheet to the manager
-
  !python {model: hr_timesheet_sheet.sheet}: |
    self.button_confirm(cr, uid, [ref('sheet_0')])

-
  I check if billable hours are added but not validated
-
  !python {model: bss_visit_report.prepaid_hours}: |
    pph_id = self.search(cr, uid, [('contract_id','=',ref('contract_0'))])
    pph = self.browse(cr, uid, pph_id)[0]
    
    assert pph != False, "Prepaid hours object not created"
    assert len(pph.billable_hours) == 3, "Hours not added"
    assert pph.total_validated_hours == 0, "Validated hours amount not valid"
    assert pph.av_amount == 600, "Available amount not valid"

-
  I refuse the sheet
-
  !python {model: hr_timesheet_sheet.sheet}: |
    self.prepaid_draft(cr, uid, [ref('sheet_0')])

-
  I check if billable hours are removed
-
  !python {model: bss_visit_report.prepaid_hours}: |
    pph_id = self.search(cr, uid, [('contract_id','=',ref('contract_0'))])
    pph = self.browse(cr, uid, pph_id)[0]
    
    assert len(pph.billable_hours) == 0, "Hours not removed"
    assert pph.total_validated_hours == 0, "Validated hours amount not valid"
    assert pph.av_amount == 600, "Available amount not valid"
    
-
  I submit again the sheet to the manager
-
  !python {model: hr_timesheet_sheet.sheet}: |
    self.button_confirm(cr, uid, [ref('sheet_0')])
    
-
  I accept the sheet
-
  !python {model: hr_timesheet_sheet.sheet}: |
    self.prepaid_validate(cr, uid, [ref('sheet_0')])
    
-
  I check if billable are validated and correct related amounts
-
  !python {model: bss_visit_report.prepaid_hours}: |
    pph_id = self.search(cr, uid, [('contract_id','=',ref('contract_0'))])
    pph = self.browse(cr, uid, pph_id)[0]
    
    assert len(pph.billable_hours) == 3, "Hours not added"
    assert pph.total_validated_hours == 150, "Validated hours amount not valid"
    assert pph.av_amount == 450, "Available amount not valid"
    
-
  I put back the sheet in draft mode
-
  !python {model: hr_timesheet_sheet.sheet}: |
    self.prepaid_draft(cr, uid, [ref('sheet_0')])
    
-
  I check if billable hours are removed and correct related amounts
-
  !python {model: bss_visit_report.prepaid_hours}: |
    pph_id = self.search(cr, uid, [('contract_id','=',ref('contract_0'))])
    pph = self.browse(cr, uid, pph_id)[0]
    
    assert len(pph.billable_hours) == 0, "Hours not added"
    assert pph.total_validated_hours == 0, "Validated hours amount not valid"
    assert pph.av_amount == 600, "Available amount not valid"
    