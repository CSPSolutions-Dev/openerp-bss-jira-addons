<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>

        <record id="edit_visit_task_action" model="ir.ui.view">
            <field name="name">bss_visit_report.bss_visit_task_action</field>
            <field name="model">bss_visit_report.bss_visit_task_action</field>
            <field name="arch" type="xml">
                <form string="Project" version="7.0">
                    <group>
                        <field name="visit_task_id" readonly="1" />
                        <field name="state" readonly="1"
                            invisible="1" />
                        <field name="comment" />
                    </group>
                    <footer>
                        <button name="execute" string="Execute"
                            type="object" class="oe_highlight" /> or
                        <button string="Cancel" class="oe_link"
                            special="cancel" />
                    </footer>
                </form>
            </field>
        </record>

        <record model="ir.actions.act_window" id="action_task_todo">
            <field name="name">Todo Task</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">bss_visit_report.bss_visit_task_action</field>
            <field name="view_mode">form</field>
            <field name="context">{"visit_task_id": active_id, "state": 'todo'}</field>
            <field name="target">new</field>
        </record>

        <record model="ir.actions.act_window" id="action_task_cancel">
            <field name="name">Cancel Task</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">bss_visit_report.bss_visit_task_action</field>
            <field name="view_mode">form</field>
            <field name="context">{"visit_task_id": active_id, "state": 'cancelled'}</field>
            <field name="target">new</field>
        </record>

        <record model="ir.actions.act_window" id="action_task_done">
            <field name="name">Terminate Task</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">bss_visit_report.bss_visit_task_action</field>
            <field name="view_mode">form</field>
            <field name="context">{"visit_task_id": active_id, "state": 'done'}</field>
            <field name="target">new</field>
        </record>
        
        <record model="ir.actions.act_window" id="action_add_task">
        	<field name="name">Add task</field>
        	<field name="res_model">bss_visit_report.bss_visit_add_task</field>
        	<field name="view_mode">form</field>
        	<field name="context">{"visit_id": active_id}</field>
        	<field name="target">new</field>
        </record>
        
        <record model="ir.ui.view" id="view_add_task">
        	<field name="name">bss_visit_report.bss_visit_add_task</field>
        	<field name="model">bss_visit_report.bss_visit_add_task</field>
        	<field name="arch" type="xml">
        		<form string="Add task" version="7.0">
	        		<group>
		        		<field name="tasks" />
		        		<field name="visit_id" invisible="1" />
		        		<field name="related_project" />
	        		</group>
	        		<footer>
	        			<button name="execute" string="Add" type="object" class="oe_highlight" /> or
	        			<button special="cancel" string="Cancel" class="oe_link" />
	        		</footer>
        		</form>
        	</field>
        </record>

        <!-- Visit -->
        <record id="edit_visit" model="ir.ui.view">
            <field name="name">bss_visit_report.visit.form</field>
            <field name="model">bss_visit_report.visit</field>
            <field name="arch" type="xml">
                <form string="Project" version="7.0">

                    <header>
                        <button name="action_validate" string="Validate"
                            type="object" states="draft"
                            groups="bss_visit_report.group_visit_report_user"
                            class="oe_highlight" />
                        <button name="action_terminate" string="Terminate"
                            type="object" states="pending"
                            groups="bss_visit_report.group_visit_report_user"
                            class="oe_highlight" />
                        <button name="%(action_add_task)d" string="Add task"
                        	type="action" attrs="{'invisible': [('state','=','draft')]}" />
                        <!-- <button name="action_reopen" string="Re-open" 
                            type="object"
                            states="terminated" groups="bss_visit_report.group_visit_report_user" 
                            /> -->
                        <field name="state" widget="statusbar"
                            statusbar_colors='{"draft":"blue"}'
                            readonly="1" />
                    </header>
                    <sheet string="Visit">
                        <div>
                            <h1>
                                <label string="Visit Report"
                                    class="oe_inline" />
                                <field name="ref" nolabel="True"
                                    class="oe_inline" />
                            </h1>
                            <h3>
                                <field name="customer_id" nolabel="True" />
                            </h3>
                        </div>
                        <group>
                            <group>
                                <field name="project_id"
                                    on_change="onchange_project_id(project_id)" />
                                <field name="user_id" />
                                <field name="customer_contact_id" />
                                <field name="signer" />
                                <field name="date" />
                                <field name="customer_ref" />
                            </group>
                            <group
                                attrs="{'invisible': [('state', '=', 'draft')]}">
                                <field name="linked_task_id"
                                    states="pending,terminated" />
                                <field name="hour_from" widget="float_time"
                                    class="oe_inline" />
                                <field name="hour_to" widget="float_time"
                                    class="oe_inline" />
                                <field name="time" widget="float_time" />
                                <field name="travel_time" widget="float_time" />
                                <field name="travel_zone" />
                            </group>
                        </group>
                        <notebook states="pending,validate">
                        	<page string="Tasks">
		                        <group name="tasks" string="Tasks"
		                            attrs="{'invisible': [('state', '=', 'draft')]}">
		                            <field name="visit_task_ids" nolabel="1" context="{'default_project_id': project_id}" readonly="1">
		                                <tree string="Tasks" version="7.0"
		                                    delete="0">
		                                    <field name="description_name" />
		                                    <field name="priority" />
		                                    <field name="task_state" />
		                                    <field name="state" />
		                                    <field name="comment" readonly="1" />
		                                    <field name="visit_state"
		                                        invisible="1" />
		                                    <button type="action"
		                                        name="%(action_task_todo)d"
		                                        string="Todo" icon="gtk-go-forward"
		                                        attrs="{'invisible': ['|', ('state', 'in', ['todo']), ('visit_state', '=', 'terminated')]}" />
		                                    <button type="action"
		                                        name="%(action_task_cancel)d"
		                                        string="Cancel" icon="gtk-cancel"
		                                        attrs="{'invisible': ['|', ('state', 'not in', ['new','todo']), ('visit_state', '=', 'terminated')]}" />
		                                    <button type="action"
		                                        name="%(action_task_done)d"
		                                        string="Terminate" icon="gtk-apply"
		                                        attrs="{'invisible': ['|', ('state', 'not in', ['new','todo']), ('visit_state', '=', 'terminated')]}" />
											<button name="%(action_visit_task_continue)d" type="action" string="Split task" 
												icon="../../../../../bss_visit_report/static/src/img/icons/split_task" class="oe-split-task" attrs="{'invisible': ['|', ('state', 'not in', ['new','todo']), ('visit_state', '=', 'terminated')]}" context="{'visit_task_id':id}"/>
		                                </tree>
		                            </field>
		                        </group>
		                        <group name="closed_tasks" string="Closed Tasks"
		                            attrs="{'invisible': [('state', '=', 'draft')]}">
		                            <field name="closed_task_ids" nolabel="1">
		                                <tree string="Closed Tasks"
		                                    version="7.0">
		                                    <field name="description_name" />
		                                    <field name="priority" />
		                                    <field name="user_id" />
		                                    <field name="task_state" />
		                                </tree>
		                            </field>
		                        </group>
		                        <group name="todo_tasks" string="Todo Tasks"
		                            attrs="{'invisible': [('state', '=', 'draft')]}">
		                            <field name="todo_task_ids" nolabel="1"
		                                colspan="2">
		                                <tree string="Todo Tasks" version="7.0">
		                                	<field name="description_name" />
		                                    <field name="priority" />
		                                    <field name="user_id" />
		                                    <field name="task_state" />
		                                </tree>
		                            </field>
		                        </group>
		                        <group name="remarks" string="Remarks"
		                            attrs="{'invisible': ['|',('state', '=', 'draft'),('remarks','=',False)]}">
		                            <field name="remarks" nolabel="1"
		                                colspan="2" />
		                        </group>
                        	</page>
                        	<page string="Material">
                        		<field name="linked_sale_order_id" invisible="1" />
                        		<field name="ref_partner_id" invisible="1" />
                        		<field name="ref_pricelist_id" invisible="1" />
                        		<field name="ref_date_order" invisible="1" />
                        		<field name="ref_fiscal_position" invisible="1" />
                        		<field name="ref_shop_id" invisible="1" />
                        		<field name="material_lines">
                        			<tree string="" editable="bottom">
                        				<field name="sequence" widget="handle"/>
	                                    <field name="state" invisible="1"/>
	                                    <field name="th_weight" invisible="1"/>
	                                    <field name="product_id"
	                                        context="{'partner_id':parent.ref_partner_id, 'quantity':product_uom_qty, 'pricelist':parent.ref_pricelist_id, 'shop':parent.ref_shop_id, 'uom':product_uom}"
	                                        groups="base.group_user" 
	                                        domain="[('type','=','consu')]"
	                                        on_change="product_id_change(parent.ref_pricelist_id, product_id, product_uom_qty, product_uom, product_uos_qty, product_uos, name, parent.ref_partner_id, False, True, parent.ref_date_order, False, parent.ref_fiscal_position, False, context)"/>
	                                    <field name="name" invisible="1"/>
	                                    <field name="product_uom_qty"
	                                        context="{'partner_id':parent.ref_partner_id, 'quantity':product_uom_qty, 'pricelist':parent.ref_pricelist_id, 'shop':parent.ref_shop_id, 'uom':product_uom}"
	                                        on_change="product_id_change(parent.ref_pricelist_id, product_id, product_uom_qty, product_uom, product_uos_qty, product_uos, name, parent.ref_partner_id, False, False, parent.ref_date_order, False, parent.ref_fiscal_position, True, context)"/>
	                                    <field name="product_uom"
	                                        on_change="product_uom_change(parent.ref_pricelist_id, product_id, product_uom_qty, product_uom, product_uos_qty, product_uos, name, parent.ref_partner_id, False, False, parent.ref_date_order, context)"
	                                        groups="product.group_uom" options='{"no_open": True}'/>
	                                    <field name="product_uos_qty" groups="product.group_uos" invisible="1"/>
	                                    <field name="product_uos" string="UoS" groups="product.group_uos" invisible="1"/>
	                                    <field name="tax_id" widget="many2many_tags" domain="[('parent_id','=',False),('type_tax_use','&lt;&gt;','purchase')]" invisible="1"/>
	                                    <field name="price_unit"/>
	                                    <field name="discount" groups="sale.group_discount_per_so_line"/>
	                                    <field name="price_subtotal"/>
                        			</tree>
                        		</field>
                        	</page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="list_visit" model="ir.ui.view">
            <field name="name">bss_visit_report.visit</field>
            <field name="model">bss_visit_report.visit</field>
            <field name="arch" type="xml">
                <tree string="Project" version="7.0">
                    <field name="ref" />
                    <field name="customer_id" />
                    <field name="project_id" />
                    <field name="user_id" />
                    <field name="date" />
                    <field name="state" />
                </tree>
            </field>
        </record>

        <record model="ir.actions.act_window" id="action_visit_management">
            <field name="name">Visits</field>
            <field name="res_model">bss_visit_report.visit</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[]</field>
            <field name="context">{}</field>
        </record>

        <record model="ir.actions.act_window" id="action_visit_view_edit">
            <field name="name">Visits</field>
            <field name="res_model">bss_visit_report.visit</field>
            <field name="view_type">form</field>
            <field name="view_mode">form</field>
            <field name="domain">[]</field>
            <field name="context">{'active_id': context['active_id']}</field>            
        </record>

        <menuitem name="Visits" id="menu_visit_management"
            action="action_visit_management" parent="bss_visit_report.menu_visit_report"
            sequence="1" groups="group_visit_report_user" />

    </data>
</openerp>